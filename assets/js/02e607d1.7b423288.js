"use strict";(self.webpackChunkdocusaurus_osebna=self.webpackChunkdocusaurus_osebna||[]).push([["5562"],{2710:function(e,i,n){n.r(i),n.d(i,{metadata:()=>r,contentTitle:()=>l,default:()=>h,assets:()=>d,toc:()=>a,frontMatter:()=>s});var r=JSON.parse('{"id":"docs-mixed/proxmox-zfs-mirror","title":"Proxmox NVMe ZFS Mirror Setup","description":"A step-by-step guide to create a ZFS mirror for your Proxmox system disk using NVMe drives. This provides redundancy for your root pool, protecting your system from drive failure.","source":"@site/docs/docs-mixed/proxmox-zfs-mirror.mdx","sourceDirName":"docs-mixed","slug":"/docs-mixed/proxmox-zfs-mirror","permalink":"/docs/docs-mixed/proxmox-zfs-mirror","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Docs - mixed","permalink":"/docs/category/docs---mixed"},"next":{"title":"Mouse and Keyboard Remapping in Linux","permalink":"/docs/docs-mixed/mouse-keyboard-remapping"}}'),o=n("5893"),t=n("65");let s={sidebar_position:2},l="Proxmox NVMe ZFS Mirror Setup",d={},a=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Step 1: Identify Your Disks",id:"step-1-identify-your-disks",level:2},{value:"Step 2: Create GPT Partition Table",id:"step-2-create-gpt-partition-table",level:2},{value:"Step 3: Replicate Partition Table",id:"step-3-replicate-partition-table",level:2},{value:"Step 4: Randomize GUIDs",id:"step-4-randomize-guids",level:2},{value:"Step 5: Verify Boot Configuration",id:"step-5-verify-boot-configuration",level:2},{value:"Step 6: Format the EFI Partition",id:"step-6-format-the-efi-partition",level:2},{value:"Step 7: Initialize the Boot Partition",id:"step-7-initialize-the-boot-partition",level:2},{value:"Step 8: Check ZFS Pool Status",id:"step-8-check-zfs-pool-status",level:2},{value:"Step 9: Attach the Mirror",id:"step-9-attach-the-mirror",level:2},{value:"Step 10: Monitor Resilvering",id:"step-10-monitor-resilvering",level:2},{value:"Verification",id:"verification",level:2},{value:"Testing the Mirror",id:"testing-the-mirror",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Mirror Not Syncing",id:"mirror-not-syncing",level:3},{value:"Boot Issues",id:"boot-issues",level:3},{value:"Resilvering Stuck",id:"resilvering-stuck",level:3},{value:"Maintenance",id:"maintenance",level:2},{value:"Monitoring Mirror Health",id:"monitoring-mirror-health",level:3},{value:"Replacing a Failed Drive",id:"replacing-a-failed-drive",level:3},{value:"Benefits of ZFS Mirror",id:"benefits-of-zfs-mirror",level:2},{value:"Additional Resources",id:"additional-resources",level:2}];function c(e){let i={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(i.header,{children:(0,o.jsx)(i.h1,{id:"proxmox-nvme-zfs-mirror-setup",children:"Proxmox NVMe ZFS Mirror Setup"})}),"\n",(0,o.jsx)(i.p,{children:"A step-by-step guide to create a ZFS mirror for your Proxmox system disk using NVMe drives. This provides redundancy for your root pool, protecting your system from drive failure."}),"\n",(0,o.jsx)(i.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:"Proxmox VE installed on a single NVMe drive"}),"\n",(0,o.jsx)(i.li,{children:"A second NVMe drive of equal or larger size"}),"\n",(0,o.jsxs)(i.li,{children:["UEFI boot mode (check with ",(0,o.jsx)(i.code,{children:"proxmox-boot-tool status"}),")"]}),"\n",(0,o.jsx)(i.li,{children:"Root access to your Proxmox host"}),"\n"]}),"\n",(0,o.jsx)(i.admonition,{title:"Data Safety",type:"warning",children:(0,o.jsx)(i.p,{children:"This process modifies disk partitions. While it shouldn't affect existing data on the first drive, always ensure you have backups before proceeding."})}),"\n",(0,o.jsx)(i.h2,{id:"step-1-identify-your-disks",children:"Step 1: Identify Your Disks"}),"\n",(0,o.jsx)(i.p,{children:"List all available disks and their partitions:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"fdisk -l\nlsblk\n"})}),"\n",(0,o.jsxs)(i.p,{children:["Identify which disk you want to add to the mirror (e.g., ",(0,o.jsx)(i.code,{children:"/dev/nvme1n1"}),")."]}),"\n",(0,o.jsx)(i.h2,{id:"step-2-create-gpt-partition-table",children:"Step 2: Create GPT Partition Table"}),"\n",(0,o.jsx)(i.p,{children:"Initialize the new disk with GPT partitioning:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"gdisk /dev/nvme1n1\n"})}),"\n",(0,o.jsx)(i.p,{children:"In the gdisk interactive prompt:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{children:"o      # Create a new empty GPT partition table\nn      # Create new partition\n       # Press Enter for default start sector\n+1G    # End sector (match the size of your first disk's EFI partition)\nef00   # EFI System partition type code\nw      # Write changes and exit\n"})}),"\n",(0,o.jsx)(i.admonition,{title:"EFI Partition Size",type:"info",children:(0,o.jsxs)(i.p,{children:["Match the size of your existing EFI partition. Use ",(0,o.jsx)(i.code,{children:"lsblk"})," to check the size on your first drive (usually around 512MB to 1GB)."]})}),"\n",(0,o.jsx)(i.h2,{id:"step-3-replicate-partition-table",children:"Step 3: Replicate Partition Table"}),"\n",(0,o.jsx)(i.p,{children:"Copy the partition layout from your existing boot drive to the new drive:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"sgdisk /dev/nvme0n1 -R /dev/nvme1n1\n"})}),"\n",(0,o.jsx)(i.p,{children:"Where:"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.code,{children:"/dev/nvme0n1"})," is your ",(0,o.jsx)(i.strong,{children:"existing"})," boot drive"]}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.code,{children:"/dev/nvme1n1"})," is your ",(0,o.jsx)(i.strong,{children:"new"})," drive"]}),"\n"]}),"\n",(0,o.jsx)(i.admonition,{title:"Understanding -R",type:"tip",children:(0,o.jsxs)(i.p,{children:["The ",(0,o.jsx)(i.code,{children:"-R"})," argument replicates the entire partition table, including all GUIDs. This creates an exact copy of the partition structure."]})}),"\n",(0,o.jsx)(i.h2,{id:"step-4-randomize-guids",children:"Step 4: Randomize GUIDs"}),"\n",(0,o.jsx)(i.p,{children:"Generate unique GUIDs for the new drive:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"sgdisk -G /dev/nvme1n1\n"})}),"\n",(0,o.jsx)(i.p,{children:"This ensures the new drive has different partition GUIDs than your boot drive, which is necessary for proper operation."}),"\n",(0,o.jsx)(i.h2,{id:"step-5-verify-boot-configuration",children:"Step 5: Verify Boot Configuration"}),"\n",(0,o.jsx)(i.p,{children:"Check your bootloader type:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"proxmox-boot-tool status\n"})}),"\n",(0,o.jsx)(i.p,{children:'Look for the word "UEFI" in the output. If you see "Grub" instead, this guide may not apply to your setup.'}),"\n",(0,o.jsx)(i.admonition,{type:"warning",children:(0,o.jsx)(i.p,{children:"This guide is specifically for UEFI boot mode. If you're using Grub, you'll need different steps."})}),"\n",(0,o.jsx)(i.h2,{id:"step-6-format-the-efi-partition",children:"Step 6: Format the EFI Partition"}),"\n",(0,o.jsx)(i.p,{children:"Format the EFI system partition on the new disk:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"proxmox-boot-tool format /dev/nvme1n1p2 --force\n"})}),"\n",(0,o.jsxs)(i.p,{children:["Where ",(0,o.jsx)(i.code,{children:"/dev/nvme1n1p2"})," is the EFI partition on your new drive."]}),"\n",(0,o.jsx)(i.h2,{id:"step-7-initialize-the-boot-partition",children:"Step 7: Initialize the Boot Partition"}),"\n",(0,o.jsx)(i.p,{children:"Initialize the Proxmox boot tool on the new drive:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"proxmox-boot-tool init /dev/nvme1n1p2\n"})}),"\n",(0,o.jsx)(i.p,{children:"This configures the new drive to be bootable."}),"\n",(0,o.jsx)(i.h2,{id:"step-8-check-zfs-pool-status",children:"Step 8: Check ZFS Pool Status"}),"\n",(0,o.jsx)(i.p,{children:"View your current ZFS pool configuration:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"zpool status\n"})}),"\n",(0,o.jsx)(i.p,{children:"Look for the device ID of your existing root pool partition. It will look something like:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{children:"nvme-eui.0025385591b0008b-part3\n"})}),"\n",(0,o.jsx)(i.p,{children:"Copy this device ID for the next step."}),"\n",(0,o.jsx)(i.h2,{id:"step-9-attach-the-mirror",children:"Step 9: Attach the Mirror"}),"\n",(0,o.jsx)(i.p,{children:"Attach the new drive to create a ZFS mirror:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"zpool attach rpool nvme-eui.0025385591b0008b-part3 /dev/nvme1n1p3\n"})}),"\n",(0,o.jsx)(i.p,{children:"Where:"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.code,{children:"rpool"})," is your root pool name"]}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.code,{children:"nvme-eui.0025385591b0008b-part3"})," is the device ID from step 8"]}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.code,{children:"/dev/nvme1n1p3"})," is the largest partition on your new drive"]}),"\n"]}),"\n",(0,o.jsx)(i.admonition,{title:"Finding Partitions",type:"info",children:(0,o.jsxs)(i.p,{children:["Use ",(0,o.jsx)(i.code,{children:"lsblk"})," to identify partition numbers. The largest partition (usually p3) contains your ZFS root pool."]})}),"\n",(0,o.jsx)(i.h2,{id:"step-10-monitor-resilvering",children:"Step 10: Monitor Resilvering"}),"\n",(0,o.jsx)(i.p,{children:"ZFS will now resilver (copy) all data to the new drive:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"zpool status\n"})}),"\n",(0,o.jsx)(i.p,{children:"You'll see a progress indicator. This can take several hours depending on the amount of data."}),"\n",(0,o.jsx)(i.p,{children:"Example output:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{children:"  resilvering: 45% done, 2h30m to go\n"})}),"\n",(0,o.jsx)(i.h2,{id:"verification",children:"Verification"}),"\n",(0,o.jsx)(i.p,{children:"Once resilvering is complete, verify your mirror:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"zpool status rpool\n"})}),"\n",(0,o.jsx)(i.p,{children:"You should see both drives listed in a MIRROR configuration:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{children:"NAME                                    STATE     READ WRITE CKSUM\nrpool                                   ONLINE       0     0     0\n  mirror-0                              ONLINE       0     0     0\n    nvme-eui.0025385591b0008b-part3    ONLINE       0     0     0\n    nvme-eui.e8238fa6bf530001-part3    ONLINE       0     0     0\n"})}),"\n",(0,o.jsx)(i.p,{children:"Check boot configuration:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"proxmox-boot-tool status\n"})}),"\n",(0,o.jsx)(i.p,{children:"Both drives should be listed as boot devices."}),"\n",(0,o.jsx)(i.h2,{id:"testing-the-mirror",children:"Testing the Mirror"}),"\n",(0,o.jsx)(i.p,{children:"To test if the mirror works:"}),"\n",(0,o.jsxs)(i.ol,{children:["\n",(0,o.jsx)(i.li,{children:"Power down the system"}),"\n",(0,o.jsx)(i.li,{children:"Physically disconnect one NVMe drive"}),"\n",(0,o.jsx)(i.li,{children:"Boot the system - it should boot normally from the remaining drive"}),"\n",(0,o.jsx)(i.li,{children:"Check ZFS status - you'll see the missing drive as UNAVAIL"}),"\n"]}),"\n",(0,o.jsx)(i.admonition,{type:"caution",children:(0,o.jsx)(i.p,{children:"This is an optional test. Only perform if you're comfortable with hardware changes."})}),"\n",(0,o.jsx)(i.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,o.jsx)(i.h3,{id:"mirror-not-syncing",children:"Mirror Not Syncing"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:"Verify both drives are the same size or the second is larger"}),"\n",(0,o.jsxs)(i.li,{children:["Check ",(0,o.jsx)(i.code,{children:"dmesg"})," for any disk errors"]}),"\n",(0,o.jsx)(i.li,{children:"Ensure you used the correct partition numbers"}),"\n"]}),"\n",(0,o.jsx)(i.h3,{id:"boot-issues",children:"Boot Issues"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:["Verify UEFI boot entries: ",(0,o.jsx)(i.code,{children:"efibootmgr -v"})]}),"\n",(0,o.jsxs)(i.li,{children:["Reinitialize boot partition: ",(0,o.jsx)(i.code,{children:"proxmox-boot-tool refresh"})]}),"\n",(0,o.jsx)(i.li,{children:"Check BIOS boot order settings"}),"\n"]}),"\n",(0,o.jsx)(i.h3,{id:"resilvering-stuck",children:"Resilvering Stuck"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:["Check system load: ",(0,o.jsx)(i.code,{children:"top"})]}),"\n",(0,o.jsxs)(i.li,{children:["Monitor ZFS I/O: ",(0,o.jsx)(i.code,{children:"zpool iostat rpool 5"})]}),"\n",(0,o.jsxs)(i.li,{children:["Verify no disk errors: ",(0,o.jsx)(i.code,{children:"smartctl -a /dev/nvme1n1"})]}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"maintenance",children:"Maintenance"}),"\n",(0,o.jsx)(i.h3,{id:"monitoring-mirror-health",children:"Monitoring Mirror Health"}),"\n",(0,o.jsx)(i.p,{children:"Regular checks:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"# Check pool health\nzpool status\n\n# Check disk SMART data\nsmartctl -a /dev/nvme0n1\nsmartctl -a /dev/nvme1n1\n\n# View ZFS events\nzpool events\n"})}),"\n",(0,o.jsx)(i.h3,{id:"replacing-a-failed-drive",children:"Replacing a Failed Drive"}),"\n",(0,o.jsx)(i.p,{children:"If a drive fails:"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-bash",children:"# Replace the failed drive (assuming nvme1n1 failed)\nzpool replace rpool /dev/nvme1n1p3 /dev/nvme2n1p3\n\n# Don't forget to reinstall the bootloader\nproxmox-boot-tool format /dev/nvme2n1p2 --force\nproxmox-boot-tool init /dev/nvme2n1p2\n"})}),"\n",(0,o.jsx)(i.h2,{id:"benefits-of-zfs-mirror",children:"Benefits of ZFS Mirror"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.strong,{children:"Redundancy"}),": System survives a single drive failure"]}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.strong,{children:"Data Integrity"}),": ZFS checksums protect against silent corruption"]}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.strong,{children:"Easy Recovery"}),": Automatic resilvering when replacing drives"]}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.strong,{children:"No Performance Loss"}),": Mirror can improve read performance"]}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"additional-resources",children:"Additional Resources"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"https://pve.proxmox.com/wiki/ZFS_on_Linux",children:"Proxmox ZFS Documentation"})}),"\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"https://openzfs.github.io/openzfs-docs/",children:"ZFS Administration Guide"})}),"\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"https://pve.proxmox.com/wiki/Host_Bootloader",children:"Proxmox Boot Tool Documentation"})}),"\n"]})]})}function h(e={}){let{wrapper:i}={...(0,t.a)(),...e.components};return i?(0,o.jsx)(i,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},65:function(e,i,n){n.d(i,{Z:function(){return l},a:function(){return s}});var r=n(7294);let o={},t=r.createContext(o);function s(e){let i=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(t.Provider,{value:i},e.children)}}}]);